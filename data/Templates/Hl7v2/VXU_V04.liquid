{
    "resourceType": "Bundle",
    "type": "batch",
    "entry": [
        {% assign firstSegments = hl7v2Data | get_first_segments: 'PID|PD1|PV1|ORC|MSH' -%}

        {% evaluate messageHeaderId using 'ID/MessageHeader' MSH: firstSegments.MSH -%}
        {% evaluate organizationId4 using 'ID/Organization' HD: firstSegments.MSH.4 -%}
        {% evaluate organizationId6 using 'ID/Organization' HD: firstSegments.MSH.6 -%}
        {% evaluate organizationId22 using 'ID/Organization' XON: firstSegments.MSH.22 -%}
        {% evaluate organizationId23 using 'ID/Organization' XON: firstSegments.MSH.23 -%}

        {% if organizationId4 -%}
            {% include 'Resource/Organization' MSH: firstSegments.MSH, ID: organizationId4 -%}
        {% endif -%}

        {% if organizationId6 -%}
            {% include 'Resource/Organization' MSH: firstSegments.MSH, ID: organizationId6 -%}
        {% endif -%}

        {% if organizationId22 -%}
            {% include 'Resource/Organization' MSH: firstSegments.MSH, ID: organizationId22 -%}
        {% endif -%}

        {% if organizationId23 -%}
            {% include 'Resource/Organization' MSH: firstSegments.MSH, ID: organizationId23 -%}
        {% endif -%}

        {% if messageHeaderId -%}
            {% include 'Resource/MessageHeader' MSH: firstSegments.MSH, Organization_ID_MSH_4: organizationId4, Organization_ID_MSH_6: organizationId6, Organization_ID_MSH_22: organizationId22, Organization_ID_MSH_23: organizationId23, ID: messageHeaderID -%}
        {% endif -%}

        {% evaluate patientId using 'ID/Patient' PID: firstSegments.PID, type: 'First' -%}
        {% evaluate organizationId_PD1_3 using 'ID/Organization' XON: firstSegments.PD1.3 -%}

        {% if organizationId_PD1_3 -%}
            {% include 'Resource/Organization' PD1: firstSegments.PD1, ID: organizationId_PD1_3 -%}
        {% endif -%}

        {% if patientId -%}
            {% assign fullPatientId = patientId | prepend: 'Patient/' -%}
            {% include 'Resource/Patient' PID: firstSegments.PID, PD1: firstSegments.PD1, Organization_ID_PD1_3: organizationId_PD1_3, ID: patientId -%}
        {% endif -%}

        {% evaluate provenanceId using 'ID/Provenance' MSH: firstSegments.MSH, baseId: patientId -%}
        {% evaluate practitionerId10 using 'ID/Practitioner' XCN: firstSegments.ORC.10 -%}
        {% evaluate practitionerId11 using 'ID/Practitioner' XCN: firstSegments.ORC.11 -%}
        {% evaluate practitionerId12 using 'ID/Practitioner' XCN: firstSegments.ORC.12 -%}
        {% evaluate locationId using 'ID/Location' XON: firstSegments.ORC.21 -%}

        {% if practitionerId10 -%}
            {% include 'Resource/Practitioner' ORC: firstSegments.ORC, ID: practitionerId10 -%}
        {% endif %}

        {% if practitionerId11 -%}
            {% include 'Resource/Practitioner' ORC: firstSegments.ORC, ID: practitionerId11 -%}
        {% endif %}

        {% if practitionerId12 -%}
            {% include 'Resource/Practitioner' ORC: firstSegments.ORC, ID: practitionerId12 -%}
        {% endif %}

        {% if locationId -%}
            {% include 'Resource/Location' ORC: firstSegments.ORC, ID: locationId -%}
        {% endif -%}

        {% if provenanceId -%}
            {% include 'Resource/Provenance' MSH: firstSegments.MSH, ORC: firstSegments.ORC, Organization_ID_MSH_4： organizationId4, Organization_ID_MSH_22： organizationId22, Practitioner_ID_ORC_10: practitionerId10, Practitioner_ID_ORC_11: practitionerId11, Practitioner_ID_ORC_12: practitionerId12, Location_ID_ORC_21: locationId, ID: provenanceId -%}
        {% endif -%}

        {% evaluate accountId using 'ID/Account' CX: firstSegments.PID.3 -%}
        {% if accountId -%}
            {% include 'Resource/Account' PID: firstSegments.PID, ID: accountId -%}
        {% endif -%}

        {% evaluate organizationId using 'ID/Organization' HD: firstSegments.MSH.6 -%}
        {% if organizationId -%}
            {% include 'Resource/Organization' MSH: firstSegments.MSH, ID: organizationId -%}
        {% endif -%}
        
        {% evaluate encounterId using 'ID/Encounter' PV1: firstSegments.PV1, baseId: patientId -%}
        {% if encounterId -%}
            {% include 'Resource/Encounter' PV1: firstSegments.PV1, ID: encounterId -%}

            {% evaluate locationId3 using 'ID/Location' PL: firstSegments.PV1.3 -%}
            {% if locationId3 -%}
                {% include 'Resource/Location' PL: firstSegments.PV1.3, ID: locationId3 -%}
            {% endif -%}

            {% evaluate locationId6 using 'ID/Location' PL: firstSegments.PV1.6 -%}
            {% if locationId6 -%}
                {% include 'Resource/Location' PL: firstSegments.PV1.6, ID: locationId6 -%}
            {% endif -%}

            {% evaluate practitionerId7 using 'ID/Practitioner' XCN: firstSegments.PV1.7 -%}
            {% if practitionerId7 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV1, ID: practitionerId7 -%}
            {% endif -%}

            {% evaluate practitionerId8 using 'ID/Practitioner' XCN: firstSegments.PV1.8 -%}
            {% if practitionerId8 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV1, ID: practitionerId8 -%}
            {% endif -%}

            {% evaluate practitionerId9 using 'ID/Practitioner' XCN: firstSegments.PV1.9 -%}
            {% if practitionerId9 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV1, ID: practitionerId9 -%}
            {% endif -%}

            {% evaluate practitionerId17 using 'ID/Practitioner' XCN: firstSegments.PV1.17 -%}
            {% if practitionerId17 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV1, ID: practitionerId17 -%}
            {% endif -%}

            {% evaluate practitionerId52 using 'ID/Practitioner' XCN: firstSegments.PV1.52 -%}
            {% if practitionerId52 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV1, ID: practitionerId52 -%}
            {% endif -%}

            {% include 'Resource/Encounter' PV1: firstSegments.PV1, Location_ID_PV1_3: locationId3, Location_ID_PV1_6: locationId6, Practitioner_ID_PV1_7: practitionerId7, Practitioner_ID_PV1_8: practitionerId8, Practitioner_ID_PV1_9: practitionerId9, Practitioner_ID_PV1_17: practitionerId17, Practitioner_ID_PV1_52: practitionerId52, ID: encounterId -%}
            
            {% if patientId -%}
                {% include 'Reference/Encounter/Subject' ID: encounterId, REF: fullPatientId -%}
            {% endif %}
        {% endif -%}
        
        {% assign nk1SegmentLists = hl7v2Data | get_segment_lists: 'NK1' -%}
        {% for nk1Segment in nk1SegmentLists.NK1 -%}
            {% evaluate organizationId_NK1_13 using 'ID/Organization' XON: nk1Segment.13 -%}

            {% if organizationId_NK1_13 -%}
                {% include 'Resource/Organization' NK1: nk1Segment, ID: organizationId_NK1_13 -%}
            {% endif -%}

            {% include 'Resource/Patient' NK1: nk1Segment, Organization_ID_NK1_13: organizationId_NK1_13, ID: patientId -%}

            {% evaluate relatedPersonId using 'ID/RelatedPerson' NK1: nk1Segment, baseId: patientId -%}
            {% if relatedPersonId -%}
                {% include 'Resource/RelatedPerson' NK1: nk1Segment, ID: relatedPersonId -%}
                {% if patientId -%}
                    {% include 'Reference/RelatedPerson/Patient' ID: relatedPersonId, REF: fullPatientId -%}
                {% endif -%}
            {% endif -%}
        {% endfor -%}

        {% assign orcSegmentLists = hl7v2Data | get_segment_lists: 'ORC' -%}
        {% for orcSegment in orcSegmentLists.ORC -%}
            {% evaluate immunizationId using 'ID/Immunization' ORC: orcSegment, baseId: patientId -%}
            {% evaluate practitionerId using 'ID/Practitioner' XCN: orcSegment.12 -%}

            {% if practitionerId -%}
                {% include 'Resource/Practitioner' ORC: orcSegment, ID: practitionerId -%}
            {% endif -%}

            {% if immunizationId -%}
                {% assign fullImmunizationId = immunizationId | prepend: 'Immunization/' -%}
                {% include 'Resource/Immunization' ORC: orcSegment, Practitioner_ID_ORC_12: practitionerId, ID: immunizationId -%}
                {% if patientId -%}
                    {% include 'Reference/Immunization/Patient' ID: immunizationId, REF: fullPatientId -%}
                {% endif -%}
            {% endif -%}

            {% assign rxaSegmentLists = hl7v2Data | get_related_segment_list: orcSegment, 'RXA' -%}
            {% for rxaSegment in rxaSegmentLists.RXA -%}
                {% evaluate practitionerId using 'ID/Practitioner' XCN: rxaSegment.10 -%}
                {% evaluate organizationId using 'ID/Organization' CWE: rxaSegment.17 -%}
                {% evaluate locationId using 'ID/Location' CWE: rxaSegment.27 -%}

                {% if practitionerId -%}
                    {% include 'Resource/Practitioner' RXA: rxaSegment, ID: practitionerId -%}
                {% endif -%}

                {% if organizationId -%}
                    {% include 'Resource/Organization' RXA: rxaSegment, ID: organizationId -%}
                {% endif -%}

                {% if locationId -%}
                    {% include 'Resource/Location' RXA: rxaSegment, ID: locationId -%}
                {% endif -%}

                {% include 'Resource/Immunization' RXA: rxaSegment, Practitioner_ID_RXA_10: practitionerId, Organization_ID_RXA_17: organizationId, Location_ID_RXA_27: locationId, ID: immunizationId -%}

                {% assign obxSegmentLists = hl7v2Data | get_related_segment_list: rxaSegment, 'OBX' -%}
                {% for obxSegment in obxSegmentLists.OBX -%}
                    {% evaluate observationId using 'ID/Observation' OBX: obxSegment, baseId: patientId -%}
                    {% evaluate practitionerId using 'ID/Practitioner' XCN: obxSegment.16 -%}
                    {% evaluate practitionerRoleId using 'ID/PractitionerRole' XCN: obxSegment.25 -%}
                    {% evaluate organizationId using 'ID/Organization' XON: obxSegment.23 -%}

                    {% if practitionerId -%}
                        {% include 'Resource/Practitioner' OBX: obxSegment, ID: practitionerId -%}
                    {% endif -%}

                    {% if practitionerRoleId -%}
                        {% include 'Resource/PractitionerRole' OBX: obxSegment, Practitioner_ID_OBX_16: practitionerId, Organization_ID_OBX_23: organizationId, ID: practitionerRoleId -%}
                    {% endif %}

                    {% if organizationId -%}
                        {% include 'Resource/Organization' OBX: obxSegment, ID: organizationId -%}
                    {% endif -%}

                    {% if observationId -%}
                        {% include 'Resource/Observation' OBX: obxSegment, Practitioner_ID_OBX_16: practitionerId, PractitionerRole_ID_OBX_25: practitionerRoleId, Organization_ID_OBX_23: organizationId, ID: observationId -%}
                        {% include 'Reference/Observation/PartOf' ID: observationId, REF: fullImmunizationId -%}
                        {% if patientId -%}
                            {% include 'Reference/Observation/Subject' ID: observationId, REF: fullPatientId -%}
                        {% endif -%}
                    {% endif -%}
                {% endfor -%}
            {% endfor -%}
        {% endfor -%}
    ] 
}